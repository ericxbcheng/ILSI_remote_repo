---
title: "Sampling 3D Simulation"
author: "Xianbin Cheng"
date: "07/17/2020"
output: html_document
---

# Objective

  To analyze data from 10,000 iterations of 3D simulation
  
# Method

1. Necessary inputs

```{r, warning = FALSE, message = FALSE}
library(kableExtra)
library(sensitivity)
source(file = "Sampling_libraries.R")
source(file = "Sampling_contamination.R")
source(file = "Sampling_contamination_3d.R")
source(file = "Sampling_visualization.R")
source(file = "Sampling_assay_prep.R")
source(file = "Sampling_plan.R")
source(file = "Sampling_plan_3d.R")
source(file = "Sampling_assay_3d.R")
source(file = "Sampling_assay.R")
source(file = "Sampling_outcome_3d.R")
source(file = "Sampling_outcome.R")
source(file = "Sampling_iteration.R")
source(file = "Sampling_tuning_3d.R")
source(file = "Sampling_analysis.R")
```

```{r}
# Important parameters
homogeneity = 0.1
Mc = 20

# Iteration
n_iter = 100
n_seed = 100

# Parameter tuning
c_hat_vec = c(5, 10, 20, 40, 80, 100)
n_affected_vec = c(1, 10, 100)
n_sp_vec = c(5, 10, 100)
method_sp_vec = c("srs", "strs", "ss")
```

2. Load all the RDS files and clean them up.

```{r, echo = FALSE}
f_clean_up = function(data, vals_prim, vals_sec, vals_tert, n_seed){

  # Clean up the data on the secondary tuning level
  a = map(.x = data, .f = metrics_dis_sec, vals_prim = vals_prim, vals_sec = vals_sec, n_seed = n_seed) %>%
    bind_rows()

  # Create a vector that specifies the tertiary tuning level
  b = as.character(rep(x = vals_tert, each = length(vals_prim) * length(vals_sec) * n_seed))

  # Combine
  return(data.frame(a, param3 = b, stringsAsFactors = FALSE))
}
```

```{r, eval = FALSE}
# Get the RDS file names
rds_files = dir(path = paste0(getwd(), "/RDS/3D Simulation"),pattern = ".rds", full.names = TRUE)

# Read rds files
exp1 = map(.x = str_subset(string = rds_files, pattern = "9"), .f = readRDS)
exp2 = map(.x = str_subset(string = rds_files, pattern = "9", negate = TRUE), .f = readRDS)

# Clean up the rds files into csv files
exp1_cleaned = f_clean_up(data = exp1, vals_prim = c_hat_vec, vals_sec = method_sp_vec, vals_tert = n_affected_vec, n_seed = n_seed)

exp2_cleaned = f_clean_up(data = exp2, vals_prim = c_hat_vec, vals_sec = n_sp_vec, vals_tert = n_affected_vec, n_seed = n_seed)
```

```{r, echo = FALSE, message = FALSE}
exp1_cleaned = read.csv(file = "sim_3D_exp1_9_srsxstrsxss_1x10x100_100x100.csv", header = TRUE, row.names = 1, stringsAsFactors = FALSE)
exp2_cleaned = read.csv(file = "sim_3D_exp2_5x10x100_srs_1x10x100_100x100.csv", header = TRUE, row.names = 1, stringsAsFactors = FALSE)
```

```{r, echo = FALSE}
exp_names = tibble(experiment = c(1,2), 
                   c_hat = rep(x = str_c(c_hat_vec, collapse = ","), times = 2), 
                   homogeneity = rep(homogeneity, 2), 
                   n_sp = c("9", str_c(as.character(n_sp_vec), collapse = ",")), 
                   method_sp = c(str_c(method_sp_vec, collapse = ","), "srs"), 
                   n_affected = rep(str_c(as.character(n_affected_vec), collapse = ","), times = 2), 
                   n_seed = rep(n_seed, times = 2), 
                   n_iter = rep(n_iter, times = 2))

kable_styling(kable_input = kable(x = exp_names, format = "html"), full_width = TRUE)
```

2. Further summarizing of the data to produce OC curves

```{r}
# Combine two experiments
exp_all_cleaned = exp1_cleaned %>%
  mutate(n_sp = 7, experiment = 1) %>%
  rbind(cbind(exp2_cleaned, method_sp = "srs", experiment = 2))
```

3. Sensitivity analysis

```{r}
# Experiment all
sens_all = sensitivity::pcc(X = subset(x = exp_all_cleaned, select = c("param", "method_sp", "n_affected", "n_sp")), 
                            y = exp_all_cleaned$Paccept, 
                            rank = TRUE, 
                            nboot = 100, 
                            conf = 0.95)
```

4. ANOVA for `Paccept` ~ `method_sp`/`n_sp` under different `n_affected`

```{r}
# ANOVA pvalues
get_pval = function(data, form){
  a = data %>%
    dplyr::filter(param == 20)
  b = aov(formula = form, data = a) %>%
    summary() 
  return(b[[1]]$`Pr(>F)`[1])
}

pval1 = split(x = exp1_cleaned, f = exp1_cleaned$n_affected) %>%
  map(.x = ., .f = get_pval, form = Paccept ~ as.factor(method_sp))

pval2 = split(x = exp2_cleaned, f = exp2_cleaned$n_affected) %>%
  map(.x = ., .f = get_pval, form = Paccept ~ as.factor(n_sp))

pval_all = rbind.data.frame(bind_cols(pval1), bind_cols(pval2)) %>%
  mutate(experiment = c(1, 2), formula = c("Paccept ~ as.factor(method_sp)", "Paccept ~ as.factor(n_sp)"), c_hat = 20) %>%
  gather(data = ., key = "n_affected", value = "p.value", -c(experiment, formula, c_hat)) %>%
  dplyr::arrange(experiment)
```

# Results

```{r, echo = FALSE}


plot_tornado = function(data){
  
  a = rownames_to_column(.data = data$PRCC, var = "Variable")
  colnames(a)[4:6] = c("std_error", "min_ci", "max_ci")
  
  ggplot(data = a) +
    geom_crossbar(aes(x = Variable, y = original, ymin = min_ci, ymax = max_ci)) +
    geom_hline(yintercept = 0, color = "red") +
    scale_x_discrete(labels = c("Sampling strategy","Clustering", "Number of probes", "Aflatoxin concentration")) +
    scale_y_continuous(breaks = seq(-1, 1, 0.2)) +
    labs(x = "Variables", y = "PRCC index") +
    coord_flip(ylim = c(-1, 1)) +
    theme_bw()
}
```

1. Visualization: Experiment 1

```{r, echo = FALSE}
f_vis(data = OC1, tune_param = "method_sp", Mc = Mc, type = "c_hat")
```

2. Visualization: Experiment 2

```{r, echo = FALSE}
f_vis(data = OC2, tune_param = "n_sp", Mc = Mc, type = "c_hat")
```

3. Sensitivity tornado plot

```{r, echo = FALSE}
sens_all
plot_tornado(data = sens_all)
```

4. ANOVA results

```{r, echo = FALSE}
kable_styling(kable_input = kable(pval_all, format = "html"), full_width = TRUE)
```

5. Quality control figures that show how much the output concentration deviates from the input concentration.

```{r, echo = FALSE}
f_vis(data = OC1, tune_param = "method_sp", type = "diag")
f_vis(data = OC2, tune_param = "n_sp", type = "diag")
```


# Appendix

```{r, echo = FALSE}
sessionInfo()
```

