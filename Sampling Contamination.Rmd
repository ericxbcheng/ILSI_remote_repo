---
title: 'Sampling: Contamination'
author: "Xianbin Cheng"
date: "August 29, 2018"
output: html_document
---

# Method #

1. Load in libraries, visualization functions and check the session info.

```{r, warning = FALSE, message= FALSE}
source(file = "Sampling_libraries.R")
source(file = "Sampling_contamination.R")
source(file = "Sampling_visualization.R")
```

```{r}
sessionInfo()
```

2. Define the input paramaters and create a simulation function.

* `n_contam` = the number of contamination points  
* `x_lim` = the limits of the horizontal axis  
* `y_lim` = the limits of the vertical axis  
* `x` = the horizontal coordinate of the contamination center, which follows a uniform distribution (`U(0,10)`)
* `y` = the vertical coordinate of the contamination center, which follows a uniform distribution(`U(0,10)`)  
* `cont_level` = a vector that indicates the mean contamination level (CFU/g or CFU/mL) and the standard deviation, assuming contamination level follows a log normal distribution. 


**Mode 1: Discrete Spread**

* `n_affected` = the number of affected plants near the contamination spot, which follows a Poisson distribution (`Pois(lambda = 5)`)   
* `covar_mat` = covariance matrix of `x` and `y`, which defines the spread of contamination. Assume the spread follows a 2D normal distribution with var(X) = 0.25, var(Y) = 0.25 and cov(X, Y) = 0  

**Mode 2: Continuous Spread**

* `spread_radius` = the radius of the contamination spread
* `LOC` = the limit of contribution of contamination. By default, it is set at 0.001.  

```{r}
## The input parameters
n_contam = rpois(n = 1, lambda = 3)
x_lim = c(0, 10)
y_lim = c(0, 10)
cont_level = c(10^7, 10)

### Mode 1
n_affected = rpois(n = 1, lambda = 5)
covar_mat = matrix(data = c(0.25, 0, 0, 0.25), nrow = 2, ncol = 2)

### Mode 2
spread_radius = 2.5
LOC = 10^(-3)
```

```{r, echo = FALSE}
# sim_contam = function(n_contam, xlim, ylim, covariance, n_affected, radius){
#   
#   ## Generate a matrix that contains contamination coordinates
#   x = runif(n = n_contam, min = xlim[1], max = xlim[2])
#   y = runif(n = n_contam, min = ylim[1], max = ylim[2])
#   
#   spot_coord = matrix(data = c(x, y), ncol = 2) %>% 
#     as.data.frame()
#   
#   # Create a factor column.
#   label = c(rep("spot", times = n_contam), rep("spread", times = n_contam * n_affected))
#   
#   # Create a spread radius column
#   r = spread_radius
#   
#   if(n_affected != 0){
#       # Each column of spread_coord contains 2*n_affected elements, the first n_affected elements are random numbers generated from mat_1[1,1] and the second n_affected elements are random numbers generated from mat_1[1,2]
#     spread_coord = apply(X = spot_coord, MARGIN = 1, FUN = mvrnorm, n = n_affected, Sigma = covar_mat)
#     
#     # Split the spread_coord by columns, rearrange the vector of each list into an nx2 matrix, then combine these matrices by row.
#     spread_coord_2 = spread_coord %>%
#       split(x = ., f = col(.)) %>%
#       map(.x = ., .f = function(x) {matrix(x, ncol = 2)}) %>%
#       do.call(what = rbind, args = .) %>%
#       as.data.frame()
#     
#     # Give a unique identifier to each observation.
#     spread_coord_3 = naming_spread(spread_coord_2, n_contam, n_affected)
#     spot_coord_2 = naming_spot(spot_coord, n_contam)
#     
#     # Combine the contamination spot coordinates and the spread coordinates, and then combine the factor column and the spread radius column.
#     df_1 = rbind(spot_coord_2, spread_coord_3)
#     colnames(df_1) = c("X", "Y", "ID")
#     df_2 = cbind(df_1, label, r)
#     
#   } else {
#     
#     # Give a unique identifier to each observation.  
#     spot_coord_2 = naming_spot(spot_coord, n_contam)
#     
#     # Give the spot_coord_2 labels and radius column
#     df_1 = spot_coord_2
#     colnames(df_1) = c("X", "Y", "ID")
#     df_2 = cbind(df_1, label, r)
#     
#     }
#   
#   # Remove points that are outside the perimeter.
#   out = which(df_2[ ,1] < xlim[1] | 
#                 df_2[ , 1] > xlim[2] | 
#                 df_2[,2] < ylim[1] | 
#                 df_2[,2] > ylim[2], arr.ind = TRUE)[1]
#   if(is.na(out) == FALSE){
#     df_3 = df_2[-out, ]
#   } else {
#     df_3 = df_2
#   }
#   
#   # Reset the row names
#   rownames(df_3) = NULL
#   
#   return(df_3)
# }
```

```{r}
sim_contam
```


3. Simulate the contamination center and its spread.

```{r}
# Run this if we want reproducibility
#set.seed(123)
```

```{r}
contam_xy = sim_contam(n_contam = n_contam, xlim = x_lim, ylim = y_lim, covariance = covar_mat, n_affected = n_affected, radius = spread_radius, cont_level = cont_level) 
```

# Results #

1. Visualization of contamination spots.

**Mode 1: Discrete Spread**

```{r}
plot_contam_dis = contam_draw(data = contam_xy, spread = "discrete", xlim = x_lim, ylim = y_lim)
```

```{r}
plot_contam_dis
```

**Mode 2: Continuous Spread**

```{r}
plot_contam_cont = contam_draw(data = contam_xy, spread = "continuous", xlim = x_lim, ylim = y_lim)
```

```{r}
plot_contam_cont
```

```{r}
contam_level_draw(spread_radius = spread_radius, LOC = LOC)
```


2. Visualization of the covariance matrix that describes the contamination spread.

```{r}
### Visualize the covariance matrix
test = mvrnorm(n = 10000, mu = c(5,5), Sigma = covar_mat)
test = as.data.frame(test)
colnames(test) = c("X", "Y")

kernel_density = kde2d(x = test$X, y = test$Y, n = 50)
image(kernel_density)
contour(kernel_density, add = TRUE)
```

