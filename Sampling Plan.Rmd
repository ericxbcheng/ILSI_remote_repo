---
title: 'Sampling: Sampling Plan'
author: "Xianbin Cheng"
date: "September 7, 2018"
output: html_document
---

# Method

1. Load libraries and source R code.

```{r, warning = FALSE, message = FALSE}
source(file = "Sampling_libraries.R")
source(file = "Sampling_contamination.R")
source(file = "Sampling_visualization.R")
source(file = "Sampling_plan.R")
```

```{r}
sessionInfo()
```

2. List important parameters from `Sampling_contamination.R`.

* `n_contam` = the number of contamination points  
* `x_lim` = the limits of the horizontal axis  
* `y_lim` = the limits of the vertical axis  
* `x` = the horizontal coordinate of the contamination center, which follows a uniform distribution (`U(0,10)`)
* `y` = the vertical coordinate of the contamination center, which follows a uniform distribution(`U(0,10)`)  

** Mode 1: Discrete Spread** 

* `n_affected` = the number of affected plants near the contamination spot, which follows a Poisson distribution (`Pois(lambda = 5)`)   
* `covar_mat` = covariance matrix of `x` and `y`, which defines the spread of contamination. Assume the spread follows a 2D normal distribution with var(X) = 0.25, var(Y) = 0.25 and cov(X, Y) = 0  

** Mode 2: Continuous Spread**

* `spread_radius` = the radius of the contamination spread

```{r}
## The input parameters
n_contam = rpois(n = 1, lambda = 3)
x_lim = c(0, 10)
y_lim = c(0, 10)

### Mode 1
n_affected = rpois(n = 1, lambda = 5)
covar_mat = matrix(data = c(0.25, 0, 0, 0.25), nrow = 2, ncol = 2)

### Mode 2
spread_radius = 2.5
```

```{r}
# Generate the coordinates of contamination points
contam_xy = sim_contam(n_contam = n_contam, xlim = x_lim, ylim = y_lim, covariance = covar_mat, n_affected = n_affected, radius = spread_radius) 
```

```{r}
## Basic info of the contamination simulation
str(contam_xy)

summary(contam_xy$label)
```


3. Define parameters for generating sampling plans.

* `n_sp` = the number of sampling points
* `sp_radius` = the radius (m) of a circular region around the sample point. (Only applicable to **Mode 1: Discrete Spread**)
* `n_strata` = the number of strata (applicable to **Stratified random sampling**)
* `by` = the side along which the field is divided into strata. It is either "row" or "column".

```{r}
n_sp = 10
sp_radius = 1
n_strata = 5
by = "column"
```

4. Simulate a sampling plan. In this case, we simulate a simple random sampling plan. The coordinates of sampling points follows a uniform distribution $U(0,10)$.

```{r}
# Run this if we want reproducibility
#set.seed(123)
```

```{r, echo = FALSE}
# # Create a helper function that gives unique identifers
# naming_sp = function(n_sp, x_sp, y_sp, radius){
#   
#   # Generate a unique identifier for each sample point
#   a = rep("sp", times = n_sp)
#   b = 1:n_sp %>% as.character()
#   ID = paste(a, "-", b, sep = "")
#   
#   ## Generate a column for sample radius
#   r = rep(radius, times = n_sp)
#   
#   data.frame(X = x_sp,
#              Y = y_sp,
#              ID = ID,
#              label = "sample point",
#              r = r)
# }
# 
# # Create a function that generates a simple random sampling plan
# sim_plan_srs = function(n_sp, xlim, ylim, radius){
#   
#   ## Generate a data frame that contains the coordinates of the sampling points
#   x_sp = runif(n = n_sp, min = xlim[1], max = xlim[2])
#   y_sp = runif(n = n_sp, min = ylim[1], max = ylim[2])
#   
#   naming_sp(n_sp = n_sp, x_sp = x_sp, y_sp = y_sp, radius = radius)
# }
```

```{r}
# Create a helper function that gives unique identifers
naming_sp

# Create a function that generates a simple random sampling plan
sim_plan_srs
```


5. Simulate a stratified random sampling plan. First of all, check whether `n_sp` is a multiple of `n_strata`. Then, divide the field into strata either by row or by column.

```{r, echo = FALSE}
# # Create a function that calculates the boundaries of each stratum
# calc_bounds = function(xlim, ylim, n_strata, by){
#   if(by == "row"){
#     seq(from = ylim[1], to = ylim[2], by = (ylim[2] - ylim[1])/n_strata)
#   } else if(by == "column"){
#     seq(from = xlim[1], to = xlim[2], by = (xlim[2] - xlim[1])/n_strata)
#   }
# }
# 
# # Create a function that generates a stratified random sampling plan
# sim_plan_strs = function(n_sp, n_strata, by, xlim, ylim, radius){
#    
#   if (n_sp %% n_strata != 0) {
#     stop("n_sp is not a multiple of n_strata.")
#   } else {
#     bounds = calc_bounds(xlim = xlim, ylim = ylim, n_strata = n_strata, by = by)
#     
#     if (by == "row") {
#       x_sp = runif(n = n_sp, min = xlim[1], max = xlim[2])
#       y_sp = runif(n = n_sp, min = bounds[1:length(bounds)-1], max = bounds[2:length(bounds)])
#     } else if (by == "column") {
#       x_sp = runif(n = n_sp, min = bounds[1:length(bounds)-1], max = bounds[2:length(bounds)])
#       y_sp = runif(n = n_sp, min = ylim[1], max = ylim[2])
#     }
#     
#     naming_sp(n_sp = n_sp, x_sp = x_sp, y_sp = y_sp, radius = radius)
#   }
# }
```

```{r}
# Create a function that calculates the boundaries of each stratum
calc_bounds

# Create a function that generates a stratified random sampling plan
sim_plan_strs
```


6. Wrap different sampling plans into one function.

```{r, echo = FALSE}
# sim_plan = function(method, n_sp, xlim, ylim, radius, n_strata, by = "row"){
#   if(method == "srs"){
#     sim_plan_srs(n_sp = n_sp, xlim = x_lim, ylim = y_lim, radius = radius)
#   } else if (method == "strs"){
#     sim_plan_strs(n_sp = n_sp, n_strata = n_strata, by = by, xlim = x_lim, ylim = y_lim, radius = radius)
#   }
# }
```

```{r}
sim_plan
```

```{r}
sp_xy = sim_plan(method = "strs", n_sp = n_sp, xlim = x_lim, ylim = y_lim, radius = sp_radius, n_strata = n_strata, by = by)
```


7. Combine the `sp_xy` and `contam_xy` by row.

```{r}
contam_sp_xy = rbind(contam_xy, sp_xy)
rownames(contam_sp_xy) = NULL
```

# Results

1. Show the simulated contamination.

```{r}
# Mode 1: Discrete Spread
plot_contam_dis = contam_draw(data = contam_xy, spread = "discrete", xlim = x_lim, ylim = y_lim)

plot_contam_dis

# Mode 2: Continuous Spread
plot_contam_cont = contam_draw(data = contam_xy, spread = "continuous", xlim = x_lim, ylim = y_lim)

plot_contam_cont
```

2. Show the sample points and sample regions.

```{r}
# Simple random sampling
# plot_sp_dis_srs = sp_draw_srs(data = sp_xy, spread = "discrete", xlim = x_lim, ylim = y_lim)
# 
# plot_sp_cont_srs = sp_draw_srs(data = sp_xy, spread = "continuous", xlim = x_lim, ylim = y_lim)
```

```{r}
# # Sampling plan for continuous spread
# plot_sp_dis_srs
# 
# # Sampling plan for discrete spread
# plot_sp_cont_srs
```

```{r}
# Stratified random sampling
plot_sp_dis_strs = sp_draw(method = "strs", data = sp_xy, spread = "discrete", xlim = x_lim, ylim = y_lim, n_strata = n_strata, by = by)

plot_sp_cont_strs = sp_draw(method = "strs", data = sp_xy, spread = "continuous", xlim = x_lim, ylim = y_lim, n_strata = n_strata, by = by)
```

```{r}
plot_sp_dis_strs

plot_sp_cont_strs
```


3. Overlay the sampling plan on the simulated contamination plot.

```{r}
# Simple random sampling
# plot_overlay_cont = overlay_draw(data = contam_sp_xy, spread = "continuous", xlim = x_lim, ylim = y_lim)
# 
# plot_overlay_dis = overlay_draw(data = contam_sp_xy, spread = "discrete", xlim = x_lim, ylim = y_lim)
```

```{r}
# # Sampling plan for continuous spread
# plot_overlay_cont
# 
# # Sampling plan for discrete spread
# plot_overlay_dis
```

```{r}
# Stratified random sampling
plot_overlay_dis_strs = overlay_draw(method = "strs", data = contam_sp_xy, spread = "discrete", xlim = x_lim, ylim = y_lim, n_strata = n_strata, by = by)

plot_overlay_cont_strs = overlay_draw(method = "strs", data = contam_sp_xy, spread = "continuous", xlim = x_lim, ylim = y_lim, n_strata = n_strata, by = by)
```

```{r}
plot_overlay_dis_strs

plot_overlay_cont_strs
```

