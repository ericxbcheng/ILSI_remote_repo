---
title: "Sampling Outcome"
author: "Xianbin Cheng"
date: "September 10, 2018"
output: html_document
---

# Method  

1. Load libraries and source R code.

```{r, message = FALSE, warning = FALSE}
source("Sampling_libraries.R")
source("Sampling_plan.R")
source("Sampling_contamination.R")
source("Sampling_visualization.R")
```

```{r}
sessionInfo()
```

2. List important parameters from `Sampling_contamination.R` and `Sampling_plan.R`.

**Contamination:**  

  * `n_sim` = the number of simulations  
  * `x_lim` = the limits of the horizontal axis  
  * `y_lim` = the limits of the vertical axis  
  * `x` = the horizontal coordinate of the contamination center, which follows a uniform distribution (`U(0,10)`)
  * `y` = the vertical coordinate of the contamination center, which follows a uniform distribution(`U(0,10)`)  

  **Mode 1: Discrete Spread** 

  * `n_affected` = the number of affected plants near the contamination spot, which follows a Poisson distribution (`Pois(lambda = 5)`)   
  * `covar_mat` = covariance matrix of `x` and `y`, which defines the spread of contamination. Assume the spread follows a 2D normal distribution with var(X) =     0.25, var(Y) = 0.25 and cov(X, Y) = 0  

  **Mode 2: Continuous Spread**

  * `spread_radius` = the radius of the contamination spread

**Sampling Plan:**  

  * `n_sp` = the number of sampling points
  * `sp_radius` = the radius (m) of a circular region around the sample point. (Only applicable to **Mode 1: Discrete Spread**)

```{r}
## Contamination
n_sim = 3
x_lim = c(0, 10)
y_lim = c(0, 10)

### Mode 1
n_affected = rpois(n = 1, lambda = 5)
covar_mat = matrix(data = c(0.25, 0, 0, 0.25), nrow = 2, ncol = 2)

### Mode 2
spread_radius = 2.5

## Sampling plan
n_sp = 10
sp_radius = 1
```

```{r}
# Generate the coordinates of contamination points
contam_xy = sim_contam(n_sim = n_sim, x_lim = x_lim, y_lim = y_lim, covariance = covar_mat, n_affected = n_affected, radius = spread_radius) 

# Generate the coordinates of sample points
sp_xy = sim_plan(n_sp = n_sp, x_lim = x_lim, y_lim = y_lim, r = sp_radius)

# Generate the combined coordinates of contamination and sample points
contam_sp_xy = rbind(contam_xy, sp_xy)
rownames(contam_sp_xy) = NULL
```

```{r}
summary(contam_sp_xy$label)
```

```{r}
kable_styling(kable(subset(contam_sp_xy, select = -r), format = "html"), full_width = FALSE)
```

3. Calculate the Euclidean distance between sample points and contamination points. 

```{r}
# Create a function that calculates the Euclidean distance between points and only outputs the distances between sample points and contamination points.
calc_dist = function(df){
  
  a = dist(x = df[ ,1:2], method = "euclidean") %>% as.matrix()
  
  sp_ind = which(df$label == "sample point")
  
  b = a[-sp_ind, sp_ind] %>%
    melt(data = ., varnames = c("row_contam", "row_sp"), value.name = "Distance")
  
  return(b)
}
```

```{r}
dist_contam_sp = calc_dist(contam_sp_xy)
```

4. Evaluate the performance of the sampling plan.

**Mode 1: Discrete Spread:**  

* Determine which contamination points (spot and spread) are covered by sampling region with a radius of `r sp_radius`.

**Mode 2: Continuous Spread:**  

* Determine which sample points are within the contamination region with a radius of `r spread_radius`.

```{r}
# Create a function to idenfity points that falls within a certain distance from another point
cover = function(df_dist, df_coord, r, method){
  
  ## Find the points that meet the distance criterion
  a = df_dist %>%
    filter(Distance <= r)
  
  ## Create columns that identify each observation
  contam_ID = df_coord$ID[a$row_contam]
  
  b = substr(x = contam_ID, start = 3, stop = 3)
  contam_type = ifelse(test = b == "0", yes = "spot", no = "spread")
  
  sp_ID = df_coord$ID[a$row_sp]
  
  c = cbind(a, contam_ID, sp_ID, contam_type)
  
  ## Create output based on the method.
  if(method == "discrete") {
    d = c %>%
      arrange(.data = ., contam_ID)
  } else if (method == "continuous") {
    d = c %>%
      dplyr::filter(contam_type == "spot") %>%
      arrange(.data = ., contam_ID)
  }
  
  return(d)
}

# Create a function that calculates the rate of detection
ROD = function(df_cover, df_contam, n_sp, method){
  if(method == "discrete"){
    length(unique(df_cover$contam_ID)) / nrow(df_contam)
  } else if (method == "continuous"){
    length(unique(df_cover$sp_ID)) / n_sp
  }
}
```

```{r}
# Mode 1: Discrete Spread
cover_dis = cover(df_dist = dist_contam_sp, df_coord = contam_sp_xy, r = sp_radius, method = "discrete")

# Mode 2: Continuous Spread
cover_cont = cover(df_dist = dist_contam_sp, df_coord = contam_sp_xy, r = spread_radius, method = "continuous")
```


# Results  

1. **Mode 1: Discrete Spread**

```{r}
# Discrete Spread
plot_contam_dis = contam_draw(data = contam_xy, method = "discrete", xlim = x_lim, ylim = y_lim)
plot_sp_dis = sp_draw(data = sp_xy, method = "discrete", xlim = x_lim, ylim = y_lim)
plot_overlay_dis = overlay_draw(data = contam_sp_xy, method = "discrete", xlim = x_lim, ylim = y_lim)

plot_contam_dis
plot_sp_dis
plot_overlay_dis
```

```{r}
# Show the contamination points that are detected by sampling.
cover_dis %>%
  dplyr::select(-c(row_contam, row_sp))
```

```{r}
# Evaluation: 
ROD(df_cover = cover_dis, df_contam = contam_xy, n_sp = n_sp, method = "discrete")
```

* Therefore, we detected `r length(unique(cover_dis$contam_ID))` out of `r nrow(contam_xy)` contamination points. The rate of detection is `r length(unique(cover_dis$contam_ID)) / nrow(contam_xy)`.


2. **Mode 2: Continuous Spread**

```{r}
# Continuous Spread
plot_contam_cont = contam_draw(data = contam_xy, method = "continuous", xlim = x_lim, ylim = y_lim)
plot_sp_cont = sp_draw(data = sp_xy, method = "continuous", xlim = x_lim, ylim = y_lim)
plot_overlay_cont = overlay_draw(data = contam_sp_xy, method = "continuous", xlim = x_lim, ylim = y_lim)

plot_contam_cont
plot_sp_cont
plot_overlay_cont
```

```{r}
# Show the sample points that detected contamination
cover_cont %>%
  dplyr::select(-c(row_contam, row_sp)) 
```

```{r}
# Evaluation: 
ROD(df_cover = cover_cont, df_contam = contam_xy, n_sp = n_sp, method = "continuous")
```

* Therefore, `r length(unique(cover_cont$sp_ID))` out of `r n_sp` sample points detected contamination. The rate of detection is `r length(unique(cover_cont$sp_ID)) / n_sp`.

```{r, eval= FALSE}
pdf(file = "Sampling Plots.pdf")
  plot_contam_dis
  plot_sp_dis
  plot_overlay_dis
  plot_contam_cont
  plot_sp_cont
  plot_overlay_cont
dev.off()
```

