---
title: "Sampling Outcome"
author: "Xianbin Cheng"
date: "September 10, 2018"
output: html_document
---

# Method  

1. Load libraries and source R code.

```{r, message = FALSE, warning = FALSE}
source("Sampling_libraries.R")
source("Sampling_plan.R")
source("Sampling_contamination.R")
source("Sampling_outcome.R")
source("Sampling_visualization.R")
# library(plotly)
```

```{r}
sessionInfo()
```

2. List important parameters from `Sampling_contamination.R` and `Sampling_plan.R`.

**Contamination:**  

  * `n_contam` = the number of contamination points 
  * `x_lim` = the limits of the horizontal axis  
  * `y_lim` = the limits of the vertical axis  
  * `x` = the horizontal coordinate of the contamination center, which follows a uniform distribution (`U(0,10)`)
  * `y` = the vertical coordinate of the contamination center, which follows a uniform distribution(`U(0,10)`)  
  * `cont_level` = a vector that indicates the mean contamination level (logCFU/g or logCFU/mL) and the standard deviation in a log scale, assuming contamination level follows a log normal distribution $ln(cont\_level)$~$N(\mu, \sigma^2)$. 

  **Mode 1: Discrete Spread** 

  * `n_affected` = the number of affected plants near the contamination spot, which follows a Poisson distribution (`Pois(lambda = 5)`)   
  * `covar_mat` = covariance matrix of `x` and `y`, which defines the spread of contamination. Assume the spread follows a 2D normal distribution with var(X) =     0.25, var(Y) = 0.25 and cov(X, Y) = 0  

  **Mode 2: Continuous Spread**

  * `spread_radius` = the radius of the contamination spread. 
  * `LOC` = the limit of contribution of contamination. By default, it is set at 0.001.(Both `spread_radius` and `LOC` determine the shape of decay function that describes how much contamination from the source is contributed to a target point.)
  * `fun` = the decay function that describes the spread. It takes either "exp" or "norm".

**Sampling Plan:**  

  * `n_sp` = the number of sampling points
  * `sp_radius` = the radius (m) of a circular region around the sample point. (Only applicable to **Mode 1: Discrete Spread**)
  * `n_strata` = the number of strata (applicable to *Stratified random sampling*)
  * `by` = the side along which the field is divided into strata. It is either "row" or "column" (applicable to *Stratified random sampling*) **OR** the side along which a sample is taken every k steps (applicable to *Systematic sampling*).

```{r}
## Contamination
n_contam = rpois(n = 1, lambda = 3)
x_lim = c(0, 10)
y_lim = c(0, 10)
cont_level = c(7, 1)

### Mode 1
n_affected = rpois(n = 1, lambda = 5)
covar_mat = matrix(data = c(0.25, 0, 0, 0.25), nrow = 2, ncol = 2)

### Mode 2
spread_radius = 2.5
LOC = 10^(-3)
fun = "norm"

## Sampling plan
n_sp = 15
sp_radius = 1
n_strata = 5
by = "row"
```

3. Generate the simulation dataset.

```{r}
# Generate the coordinates of contamination points
contam_xy = sim_contam(n_contam = n_contam, xlim = x_lim, ylim = y_lim, covariance = covar_mat, n_affected = n_affected, radius = spread_radius, cont_level = cont_level) 

# Generate the coordinates of sample points
sp_xy = sim_plan(method = "srs", n_sp = n_sp, xlim = x_lim, ylim = y_lim, radius = sp_radius, by = by)

# Combine contam_xy and sp_xy
contam_sp_xy = gen_sim_data(df_contam = contam_xy, df_sp = sp_xy, spread_radius = spread_radius, LOC = LOC, fun = fun)
```

```{r}
str(contam_sp_xy)

summary(contam_sp_xy$label)
```

```{r}
kable_styling(kable(contam_sp_xy, format = "html"), full_width = FALSE)
```

```{r, echo = FALSE}
# ## Calculate the percent of contamination a source contributes to a sample point
# calc_perc_contam = function(df_dist, r, LOC){
#   f_exp(d = df_dist[["Distance"]], spread_radius = r, LOC = LOC)
# }
```

```{r, echo = FALSE}
# gen_sim_data = function(df_contam, df_sp, spread_radius, LOC){
#   
#    ## Generate the combined coordinates of contamination and sample points
#   a = rbind(df_contam, df_sp)
#   rownames(a) = NULL
# 
#   ## Calculate the Euclidean distance between sample points and contamination points.
#   dist_contam_sp = calc_dist(a)
#   
#   ## Create a column that describes the contamination contribution of the source. Then match the row_contam with rows in contam_xy and show the corresponding cont_level. Calculate contamination contribution.
#   b = dist_contam_sp %>%
#     mutate(perc_contam = calc_perc_contam(df_dist = ., r = spread_radius, LOC = LOC)) %>%
#     mutate(source_level = contam_xy$cont_level[.$row_contam],
#            source_contri = source_level * perc_contam)
# 
#   ## Sum up the source_contri for each sample point to represent the contamination level at that sample point
#   c = b %>%
#     group_by(row_sp) %>%
#     summarise(cont_level = sum(source_contri))
# 
#   ## Update the contamination level for each sample point
#   a$cont_level[c$row_sp] = c$cont_level
#   
#   return(a)
# }
```

4. Evaluate the rate of detection (ROD) of the sampling plan.

**Mode 1: Discrete Spread:**  

* Determine which contamination points (spot and spread) are covered by sampling region with a radius of `r sp_radius`.

**Mode 2: Continuous Spread:**  

* Determine which sample points are within the contamination region with a radius of `r spread_radius`.

```{r}
cover

calc_ROD
```

```{r}
dist_contam_sp = calc_dist(df = contam_sp_xy, spotONLY = FALSE)

# Mode 1: Discrete Spread
cover_dis = cover(df_dist = dist_contam_sp, df_coord = contam_sp_xy, r = sp_radius, spread = "discrete")

# Mode 2: Continuous Spread
cover_cont = cover(df_dist = dist_contam_sp, df_coord = contam_sp_xy, r = spread_radius, spread = "continuous")
```

# Results  

1. **Mode 1: Discrete Spread**

```{r, echo = FALSE}
# Simple random sampling
# plot_contam_dis = contam_draw(data = contam_xy, spread = "discrete", xlim = x_lim, ylim = y_lim)
# plot_sp_dis = sp_draw(data = sp_xy, spread = "discrete", xlim = x_lim, ylim = y_lim)
# plot_overlay_dis = overlay_draw(data = contam_sp_xy, spread = "discrete", xlim = x_lim, ylim = y_lim)
# 
# plot_contam_dis
# plot_sp_dis
# plot_overlay_dis
```

```{r, echo = FALSE}
# Stratified random sampling
# plot_contam_dis = contam_draw(data = contam_xy, spread = "discrete", xlim = x_lim, ylim = y_lim)
# plot_sp_dis = sp_draw(method = "strs", data = sp_xy, spread = "discrete", xlim = x_lim, ylim = y_lim, n_strata = n_strata, by = by)
# plot_overlay_dis = overlay_draw(method = "strs", data = contam_sp_xy, spread = "discrete", xlim = x_lim, ylim = y_lim, n_strata = n_strata, by = by)
# 
# plot_contam_dis
# plot_sp_dis
# plot_overlay_dis
```

```{r}
# Systematic sampling
plot_contam_dis = contam_draw(data = contam_xy, spread = "discrete", xlim = x_lim, ylim = y_lim)
plot_sp_dis = sp_draw(method = "srs", data = sp_xy, spread = "discrete", xlim = x_lim, ylim = y_lim, n_strata = n_strata, by = by)
plot_overlay_dis = overlay_draw(method = "srs", data = contam_sp_xy, spread = "discrete", xlim = x_lim, ylim = y_lim, n_strata = n_strata, by = by)

plot_contam_dis
plot_sp_dis
plot_overlay_dis
```

```{r}
# Show the contamination points that are detected by sampling.
cover_dis %>%
  dplyr::select(-c(row_contam, row_sp))
```

```{r}
# Evaluation: 
calc_ROD(df_cover = cover_dis, df_contam = contam_xy, n_sp = n_sp, spread = "discrete")
```

* Therefore, we detected `r length(unique(cover_dis$ID))` out of `r nrow(contam_xy)` contamination points. The rate of detection is `r length(unique(cover_dis$ID)) / nrow(contam_xy)`.


2. **Mode 2: Continuous Spread**

```{r}
# Continuous Spread
plot_contam_cont = contam_draw(data = contam_xy, spread = "continuous", xlim = x_lim, ylim = y_lim)
plot_sp_cont = sp_draw(method = "srs", data = sp_xy, spread = "continuous", xlim = x_lim, ylim = y_lim)
plot_overlay_cont = overlay_draw(method = "srs", data = contam_sp_xy, spread = "continuous", xlim = x_lim, ylim = y_lim)

plot_contam_cont
plot_sp_cont
plot_overlay_cont
```

```{r}
contam_level_draw(dimension = "3d", method = fun, spread_radius = spread_radius, LOC = LOC, df_contam = contam_xy, xlim = x_lim, ylim = y_lim, interactive = FALSE)
```

```{r}
# Show the sample points that detected contamination
cover_cont %>%
  dplyr::select(-c(row_contam, row_sp)) 
```

```{r}
# Evaluation: 
calc_ROD(df_cover = cover_cont, df_contam = contam_xy, n_sp = n_sp, spread = "continuous")
```

* Therefore, `r length(unique(cover_cont$sp_ID))` out of `r n_sp` sample points detected contamination. The rate of detection is `r length(unique(cover_cont$sp_ID)) / n_sp`.

```{r, eval= FALSE}
pdf(file = "Sampling Plots SS.pdf")
  plot_contam_dis
  plot_sp_dis
  plot_overlay_dis
  plot_contam_cont
  plot_sp_cont
  plot_overlay_cont
dev.off()
```

